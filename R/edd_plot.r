#' @name pdd_simulation_plot
#' @title Plotting results of a replicated pdd simulation
#' @description Function to automatically produce several plots from the results
#' of a replicated pdd simulation
#' @param result a list of extracted results
#' @param pars the parameters used in simulation being plotted
#' @param age the total simulation time
#' @param model the model used in the simulation
#' @param offset the offset method for Phi used in a pdd simulation
#' @return a plot grid generated by cow_plot
#' @author Tianjian Qin
#' @keywords phylogenetics
#' @export pdd_simulation_plot
pdd_simulation_plot <- function(result, pars, age, model, offset) {
  plotN <-
    ggplot2::ggplot(result[[2]], aes(time, N, group = rep, color = rep)) + ggplot2::geom_line() +
    ggplot2::theme(legend.position = "none") + xlab("age")

  if (model == "dsce1" | model == "dsde1") {
    plotPhi <-
      ggplot2::ggplot(result[[2]], aes(time, Phi, group = rep, color = rep)) + ggplot2::geom_line() +
      ggplot2::theme(legend.position = "none") + xlab("age") + ggplot2::geom_hline(yintercept = pars[3])
    title <-
      cowplot::ggdraw() + cowplot::draw_label(
        paste(
          model,
          ", ",
          "lambda = ",
          pars[1],
          ", ",
          "mu = ",
          pars[2],
          ", ",
          "K = ",
          pars[3],
          ", ",
          "age = ",
          age,
          ", ",
          "offset = ",
          offset
        ),
        fontface = 'bold'
      )
  } else if (model == "dsde2") {
    plotPhi <-
      ggplot2::ggplot(result[[2]], aes(time, Phi, group = rep, color = rep)) + ggplot2::geom_line() +
      ggplot2::theme(legend.position = "none") + xlab("age")
    title <-
      cowplot::ggdraw() + cowplot::draw_label(
        paste(
          model,
          ", ",
          "lambda = ",
          pars[1],
          ", ",
          "mu = ",
          pars[2],
          ", ",
          "betaN = ",
          pars[3],
          ", ",
          "betaPhi = ",
          pars[4],
          ", ",
          "gammaN = ",
          pars[5],
          ", ",
          "gammaPhi = ",
          pars[6],
          ", ",
          "age = ",
          age,
          ", ",
          "offset = ",
          offset
        ),
        fontface = 'bold'
      )
  } else if (model == "dsce2") {
    plotPhi <-
      ggplot2::ggplot(result[[2]], aes(time, Phi, group = rep, color = rep)) + ggplot2::geom_line() +
      ggplot2::theme(legend.position = "none") + xlab("age")
    title <-
      cowplot::ggdraw() + cowplot::draw_label(
        paste(
          model,
          ", ",
          "lambda = ",
          pars[1],
          ", ",
          "mu = ",
          pars[2],
          ", ",
          "betaN = ",
          pars[3],
          ", ",
          "betaPhi = ",
          pars[4],
          ", ",
          "age = ",
          age,
          ", ",
          "offset = ",
          offset
        ),
        fontface = 'bold'
      )
  }

  plotla <-
    ggplot2::ggplot(result[[2]], aes(time, lambda, group = rep, color = rep)) + ggplot2::geom_line() +
    ggplot2::theme(legend.position = "none") + xlab("age")
  plotmu <-
    ggplot2::ggplot(result[[2]], aes(time, mu, group = rep, color = rep)) + ggplot2::geom_line() +
    ggplot2::theme(legend.position = "none") + xlab("age")
  plotall <- cowplot::plot_grid(plotN, plotPhi, plotla, plotmu)

  plotwithtitle <-
    cowplot::plot_grid(title,
                       plotall,
                       ncol = 1,
                       rel_heights = c(0.1, 1))

  return(plotwithtitle)
}

#' @name edd_simulation_plot
#' @title Plotting results of a replicated edd simulation
#' @description Function to automatically produce several plots from the results
#' of a replicated edd simulation
#' @param result a list of extracted results
#' @param pars the parameters used in simulation being plotted
#' @param age the total simulation time
#' @param model the model used in the simulation
#' @return a plot grid generated by cow_plot
#' @author Tianjian Qin
#' @keywords phylogenetics
#' @export edd_simulation_plot
edd_simulation_plot <-
  function(result,
           pars,
           age,
           model,
           offset) {
    plotN <-
      ggplot2::ggplot(result[[2]], aes(time, N, group = rep, color = rep)) + ggplot2::geom_line() +
      ggplot2::theme(legend.position = "none") + xlab("age")

    tree <-
      ggtree::ggtree(result$result_raw[, 1]$tas) + ggtree::geom_tiplab(size = 4)

    relas <-
      dplyr::bind_cols(result$result_raw[, 1]$LTT$time, result$result_raw[, 1]$las)
    relas <- relas %>% tibble::column_to_rownames(var = "...1")

    remus <-
      dplyr::bind_cols(result$result_raw[, 1]$LTT$time, result$result_raw[, 1]$mus)
    remus <- remus %>% tibble::column_to_rownames(var = "...1")

    plotlas <- ggtree::gheatmap(
      tree,
      t(relas),
      offset = 0.6,
      width = 0.8,
      colnames = FALSE,
      legend_title = "PSR"
    )

    plotmus <- ggtree::gheatmap(
      tree,
      t(remus),
      offset = 0.6,
      width = 0.8,
      colnames = FALSE,
      legend_title = "PER"
    )

    plot_bottom <- cowplot::plot_grid(plotlas, plotmus)

    plotall <-
      cowplot::plot_grid(plotN, plot_bottom, nrow = 2, rel_heights = c(1, 2))

    return(plotall)
  }

#' @name edd_plot
#' @title Generating plots for a replicated edd simulation
#' @description Function to automatically generate several plots from raw data
#' of a replicated edd simulation
#' @param raw_data a list of results generated by edd simulation function
#' @param tr true of false, to decide whether to truncate the plot to the range
#' between 0 and simulation age
#' @return a plot pack containing several plots
#' @author Tianjian Qin
#' @keywords phylogenetics
#' @export edd_plot
edd_plot <- function(raw_data = NULL, tr = FALSE){
  if (is.null(raw_data)) stop("No data provided")
  if (length(raw_data) != 10) stop("Bad raw data")
  correct_names <- c("all_pars", "tes", "tas", "l_tables", "brts", "nltt",
                     "eds", "las", "mus", "linlists")
  if (!identical(names(raw_data), correct_names)) stop("Bad raw data")

  # plot lineages through time
  plot_nltt <- edd_plot_nltt(raw_data, tr)

  # plot speciation rates
  plot_las <- edd_plot_las(raw_data)

  # plot extinction rates
  plot_mus <- edd_plot_mus(raw_data)

  # plot evolutionary distinctiveness-es
  plot_eds <- edd_plot_eds(raw_data)

  plot_pack <- list(plot_nltt = plot_nltt,
                    plot_las = plot_las,
                    plot_mus = plot_mus,
                    plot_eds = plot_eds
                    )

  return(plot_pack)
}

#' @name edd_plot_nltt
#' @title Generating nltt plot for a replicated edd simulation
#' @description Function to generate lineages through time plot from raw data
#' of a replicated edd simulation
#' @param raw_data a list of results generated by edd simulation function
#' @param tr true of false, to decide whether to truncate the plot to the range
#' between 0 and simulation age
#' @return an nltt plot
#' @author Tianjian Qin
#' @keywords phylogenetics
#' @export edd_plot_nltt
edd_plot_nltt <- function(raw_data = NULL, plot_options = NA, ...){
  nrep <- raw_data$all_pars$nrep
  age <- raw_data$all_pars$age
  nltt <- raw_data$nltt

  if (nrep != 1){
    nltt <- eve::bind_raw(nltt, nrep)
    nltt <- dplyr::bind_rows(nltt)
  }

  if (plot_options == TRUE) {
    plot_nltt <-
      ggplot2::ggplot(nltt, ggplot2::aes(time, num, group = as.factor(nrep), color = as.factor(nrep))) +
      ggplot2::geom_line() + ggplot2::coord_cartesian(xlim = c(0, age)) +
      ggplot2::theme(legend.position = "none") +
      ggplot2::xlab("Age") + ggplot2::ylab("Number of species")
  } else{
    plot_nltt <-
      ggplot2::ggplot(nltt, ggplot2::aes(time, num, group = as.factor(nrep), color = as.factor(nrep))) +
      ggplot2::geom_line() + ggplot2::theme(legend.position = "none") +
      ggplot2::xlab("Age") + ggplot2::ylab("Number of species")
  }

  return(plot_nltt)
}

#' @name edd_plot_las
#' @title Generating speciation rates plot for a replicated edd simulation
#' @description Function to generate a plot showing the transition of speciation
#' rates from raw data of a replicated edd simulation
#' @param raw_data a list of results generated by edd simulation function
#' @return an plot containing  plot
#' @author Tianjian Qin
#' @keywords phylogenetics
#' @export edd_plot_las
edd_plot_las <- function(raw_data = NULL, rep_id = 1){
  tree <-
    ggtree::ggtree(raw_data$tas[[rep_id]]) + ggtree::geom_tiplab(align = TRUE) +
    ggtree::theme_tree2()

  dat <- eve::match_raw(raw_data$las[[rep_id]],raw_data$linlists[[rep_id]])
  dat <- dplyr::bind_rows(dat)
  dat <- dplyr::bind_cols(dplyr::select(raw_data$nltt[[rep_id]], time), dat)
  dat <- dat %>%tibble::column_to_rownames(var = "time")

  gheatmap(tree, t(dat))

  return(plot_las)
}
